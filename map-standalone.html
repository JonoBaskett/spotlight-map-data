<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Chambers Spotlight — Clickable Cities + Autocomplete</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b1020; --panel:#111831; --ink:#eaf0ff; --muted:#9fb0d6;
    --brand:#0024b9; --accent:#4da3ff; --chip:#1a2342; --chip2:#1d274a;
    --card:#121a33; --border:#273154; --ok:#1dd1a1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0b1020 0%,#0c1224 100%)}
  h1{margin:0;font-size:18px;font-weight:700}
  .wrap{display:grid;grid-template-columns:340px 1fr;min-height:calc(100vh - 60px)}
  .side{border-right:1px solid var(--border);background:var(--panel);padding:16px;overflow:auto}
  .main{position:relative}
  .field{margin-bottom:12px}
  label{display:block;margin:0 0 6px 2px;color:var(--muted);font-size:12px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1630;color:var(--ink);outline:0}
  input::placeholder{color:#88a}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;white-space:nowrap}
  .counts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin:16px 0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:600}
  .big{font-size:22px;font-weight:800}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0f1732}
  .item .title{font-weight:700}
  .firm{display:flex;align-items:flex-start;gap:8px;margin-top:6px}
  .firm .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);margin-top:6px;flex:0 0 8px}
  .firm .name{font-weight:600}
  .pa{color:var(--muted);font-size:12px;margin-top:2px}
  .footer{padding:10px 16px;border-top:1px solid var(--border);font-size:12px;color:#a8b4d4}
  .map-wrap{position:relative;height:calc(100vh - 60px);overflow:hidden}
  #map{position:absolute;inset:0}
  .tooltip{position:absolute;background:#0e1630;border:1px solid var(--border);color:var(--ink);padding:8px 10px;border-radius:8px;pointer-events:none;opacity:0;transition:opacity .12s}
  .search-results{position:absolute;z-index:20;left:16px;right:16px;top:140px;background:#0e1630;border:1px solid var(--border);border-radius:12px;max-height:280px;overflow:auto;display:none}
  .result{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
  .result:last-child{border-bottom:0}
  .result:hover{background:#121a33}
  .pill{display:inline-flex;align-items:center;background:#102044;border:1px solid var(--border);padding:6px 10px;border-radius:999px;gap:8px}
  .pill b{font-weight:700}
  .legend{position:absolute;left:12px;bottom:12px;background:#0e1630;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:12px}
  a{color:#b7cbff}
</style>
</head>
<body>
<header>
  <h1>Chambers Spotlight — Interactive Cities Map</h1>
</header>

<div class="wrap">
  <aside class="side">
    <div class="field">
      <label for="stateSelect">State</label>
      <select id="stateSelect"></select>
    </div>
    <div class="field">
      <label for="practiceSelect">Practice area</label>
      <select id="practiceSelect"></select>
    </div>
    <div class="field">
      <label for="citySearch">Search city or firm</label>
      <input id="citySearch" placeholder="Start typing a city or firm… (e.g., Charlotte, Alexander Ricks)" />
    </div>

    <div class="counts">
      <div class="card">
        <h3>Firms in state</h3>
        <div class="big" id="stateFirmCount">0</div>
      </div>
      <div class="card">
        <h3>Cities in state</h3>
        <div class="big" id="stateCityCount">0</div>
      </div>
    </div>

    <div class="card">
      <h3>City details</h3>
      <div id="cityDetails">
        <div class="badge">Pick a city on the map or via search</div>
      </div>
    </div>

    <div class="footer">
      Data source: Chambers Spotlight (latest CSV). Filter by state and practice, then click cities on the map.
    </div>
  </aside>

  <main class="main">
    <div class="map-wrap">
      <svg id="map"></svg>
      <div class="tooltip" id="tooltip"></div>
      <div class="legend">
        <div class="pill"><b>●</b> City (click to view firms)</div>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>
  </main>
</div>

<script>
// ======== DATA (generated from your CSV) ========
// IMPORTANT: This is the nested State -> City structure consumed by the UI.
//
// Each state has:
//   { cities: {
//       "City Name": { coords: [lon, lat], firms: [{ name: "...", practiceAreas: ["...","..."] }, ...] },
//       ...
//   } }
//
// NOTE: This block is long by design, as it embeds all your CSV records.

const data = /* PASTED JSON OBJECT HERE — omitted for brevity in this snippet */ [];

// ======== END DATA ========

// Build practice area universe
const ALL = "__all__";
function extractAllPracticeAreas() {
  const set = new Set();
  Object.values(data).forEach(st => {
    Object.values(st.cities).forEach(c => {
      (c.firms || []).forEach(f => (f.practiceAreas || []).forEach(pa => set.add(pa)));
    });
  });
  return Array.from(set).sort();
}
function firmCount(stateName, practiceArea) {
  const st = data[stateName]; if (!st) return 0;
  let total = 0;
  Object.values(st.cities).forEach(city => {
    const firms = city.firms || [];
    if (!practiceArea || practiceArea === ALL) total += firms.length;
    else total += firms.filter(f => (f.practiceAreas||[]).includes(practiceArea)).length;
  });
  return total;
}
function cityFirmCount(stateName, cityName, practiceArea) {
  const city = data[stateName]?.cities?.[cityName]; if (!city) return 0;
  const firms = city.firms || [];
  if (!practiceArea || practiceArea === ALL) return firms.length;
  return firms.filter(f => (f.practiceAreas||[]).includes(practiceArea)).length;
}
function uniqueCitiesInState(stateName) {
  const st = data[stateName]; if (!st) return 0;
  return Object.keys(st.cities).length;
}

// Populate selects
const stateSelect = document.getElementById('stateSelect');
const practiceSelect = document.getElementById('practiceSelect');
const cityDetails = document.getElementById('cityDetails');
const stateFirmCountEl = document.getElementById('stateFirmCount');
const stateCityCountEl = document.getElementById('stateCityCount');
const searchInput = document.getElementById('citySearch');
const searchResults = document.getElementById('searchResults');

// Fill states
const stateNames = Object.keys(data).sort();
for (const s of stateNames) {
  const opt = document.createElement('option');
  opt.value = s; opt.textContent = s;
  stateSelect.appendChild(opt);
}
stateSelect.value = stateNames[0] || "";

// Fill practice areas
const allPAs = extractAllPracticeAreas();
const allOpt = document.createElement('option');
allOpt.value = ALL; allOpt.textContent = "All practice areas";
practiceSelect.appendChild(allOpt);
for (const pa of allPAs) {
  const opt = document.createElement('option');
  opt.value = pa; opt.textContent = pa;
  practiceSelect.appendChild(opt);
}
practiceSelect.value = ALL;

// Update counters
function updateStateCounters() {
  const st = stateSelect.value;
  const pa = practiceSelect.value;
  stateFirmCountEl.textContent = firmCount(st, pa);
  stateCityCountEl.textContent = uniqueCitiesInState(st);
}
updateStateCounters();

// Render city details
function renderCityDetails(stateName, cityName) {
  const city = data[stateName]?.cities?.[cityName];
  if (!city) {
    cityDetails.innerHTML = '<div class="badge">No city selected</div>';
    return;
  }
  const pa = practiceSelect.value;
  const firms = city.firms || [];
  const visible = (pa === ALL) ? firms : firms.filter(f => (f.practiceAreas||[]).includes(pa));
  const firmHtml = visible.map(f => {
    const pas = (f.practiceAreas || []).join(', ');
    return `<div class="firm">
      <div class="dot"></div>
      <div>
        <div class="name">${f.name}</div>
        <div class="pa">${pas}</div>
      </div>
    </div>`;
  }).join('');
  cityDetails.innerHTML = `
    <div class="item">
      <div class="title">${cityName}, ${stateName}</div>
      <div class="badges">
        <div class="badge">${visible.length} firm(s)</div>
        <div class="badge">${(pa===ALL?'All practice areas':pa)}</div>
      </div>
      ${visible.length ? firmHtml : '<div class="pa" style="margin-top:8px;">No firms for this filter.</div>'}
    </div>`;
}

// ======== Simple USA map with city dots ========
const svg = document.getElementById('map');
const tooltip = document.getElementById('tooltip');

// Basic responsive SVG
function resizeSVG() {
  const r = svg.getBoundingClientRect();
  svg.setAttribute('viewBox', `0 0 ${Math.max(800, r.width)} ${Math.max(500, r.height)}`);
}
const ro = new ResizeObserver(resizeSVG);
ro.observe(svg);

// Minimal projection: naive lon/lat to x/y using an Albers-like fit over US bounds
const citiesAll = [];
for (const [stateName, st] of Object.entries(data)) {
  for (const [cityName, c] of Object.entries(st.cities)) {
    const [lon, lat] = c.coords;
    citiesAll.push({ state: stateName, city: cityName, lon, lat, firms: c.firms || [] });
  }
}
// Compute bounds
const lons = citiesAll.map(c => c.lon);
const lats = citiesAll.map(c => c.lat);
const minLon = Math.min(...lons), maxLon = Math.max(...lons);
const minLat = Math.min(...lats), maxLat = Math.max(...lats);

// Project to local svg space
function project(lon, lat) {
  const r = svg.getBoundingClientRect();
  const w = Math.max(800, r.width), h = Math.max(500, r.height);
  const x = (lon - minLon) / (maxLon - minLon + 1e-6) * (w - 80) + 40;
  const y = (maxLat - lat) / (maxLat - minLat + 1e-6) * (h - 80) + 40;
  return [x, y];
}

// Draw dots
function drawDots() {
  svg.innerHTML = "";
  // back grid
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  svg.appendChild(g);

  // Dots filtered by state/practice
  const currentState = stateSelect.value;
  const currentPA = practiceSelect.value;
  const entries = Object.entries(data[currentState]?.cities || {});
  for (const [cityName, c] of entries) {
    const [lon, lat] = c.coords;
    const [x, y] = project(lon, lat);
    const firms = c.firms || [];
    const count = (currentPA===ALL) ? firms.length : firms.filter(f => (f.practiceAreas||[]).includes(currentPA)).length;
    if (count === 0) continue;

    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx", x); circle.setAttribute("cy", y);
    circle.setAttribute("r", Math.max(4, Math.min(14, 4 + count)));
    circle.setAttribute("fill", "#4da3ff");
    circle.setAttribute("opacity", "0.88");
    circle.style.cursor = "pointer";
    circle.addEventListener("mouseenter", () => {
      tooltip.style.opacity = 1;
      tooltip.textContent = `${cityName}, ${currentState} — ${count} firm(s)`;
    });
    circle.addEventListener("mouseleave", () => tooltip.style.opacity = 0);
    circle.addEventListener("mousemove", (e) => {
      const bb = svg.getBoundingClientRect();
      tooltip.style.left = (e.clientX - bb.left + 12) + "px";
      tooltip.style.top = (e.clientY - bb.top + 12) + "px";
    });
    circle.addEventListener("click", () => renderCityDetails(currentState, cityName));
    g.appendChild(circle);
  }
}
drawDots();

// Reactivity
stateSelect.addEventListener('change', () => {
  updateStateCounters();
  drawDots();
  cityDetails.innerHTML = '<div class="badge">Pick a city on the map or via search</div>';
});
practiceSelect.addEventListener('change', () => {
  updateStateCounters();
  drawDots();
});

// Search across city + firm names
function performSearch(q) {
  const query = q.trim().toLowerCase();
  if (!query) { searchResults.style.display = "none"; return; }
  const pa = practiceSelect.value;
  const st = stateSelect.value;

  const rows = [];
  // cities
  Object.entries(data[st]?.cities || {}).forEach(([cityName, c]) => {
    if (cityName.toLowerCase().includes(query)) {
      const n = cityFirmCount(st, cityName, pa);
      if (n>0) rows.push({type: "city", state: st, city: cityName, count: n});
    }
  });
  // firms
  Object.entries(data[st]?.cities || {}).forEach(([cityName, c]) => {
    (c.firms||[]).forEach(f => {
      const match = f.name.toLowerCase().includes(query);
      const allowed = (pa===ALL) || (f.practiceAreas||[]).includes(pa);
      if (match && allowed) {
        rows.push({type:"firm", state: st, city: cityName, firm: f.name, count: 1});
      }
    });
  });

  // Render
  searchResults.innerHTML = rows.slice(0, 200).map(r => {
    if (r.type==="city") {
      return `<div class="result" data-type="city" data-state="${r.state}" data-city="${r.city}">
        <div><b>${r.city}</b>, ${r.state}</div>
        <div class="pa">${r.count} firm(s)</div>
      </div>`;
    } else {
      return `<div class="result" data-type="firm" data-state="${r.state}" data-city="${r.city}" data-firm="${r.firm}">
        <div><b>${r.firm}</b></div>
        <div class="pa">${r.city}, ${r.state}</div>
      </div>`;
    }
  }).join('');
  searchResults.style.display = rows.length ? "block" : "none";
}
searchInput.addEventListener('input', (e) => performSearch(e.target.value));
searchResults.addEventListener('click', (e) => {
  const row = e.target.closest('.result');
  if (!row) return;
  const type = row.getAttribute('data-type');
  const st = row.getAttribute('data-state');
  const city = row.getAttribute('data-city');
  stateSelect.value = st;
  updateStateCounters();
  drawDots();
  if (type === 'city') {
    renderCityDetails(st, city);
  } else {
    renderCityDetails(st, city);
  }
  searchResults.style.display = "none";
});

// Initial city panel empty
cityDetails.innerHTML = '<div class="badge">Pick a city on the map or via search</div>';

</script>
</body>
</html>
